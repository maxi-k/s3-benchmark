#!/bin/bash
# Preamble: Parse parameters, print configuration
source ./shared/util.sh
ensure_parameters
print_configuration

# Create AWS CLI option strings for some parameters
if [ -z $AVAILABILITY_ZONE ]; then
    PLACEMENT_OPTION=""
else
    read -r -d '' PLACEMENT_OPTION <<EOF
    "Placement": {
      "AvailabilityZone": "$AVAILABILITY_ZONE"
    },
EOF
fi
echo -e "Calculated PLACEMENT_OPTION: \n $PLACEMENT_OPTION\n\n"

if [ -z $KEY_NAME ]; then
    KEY_NAME_OPTION=""
else
    read -r -d '' KEY_NAME_OPTION <<EOF
    "KeyName": "$KEY_NAME",
EOF
fi
echo -e "Calculated KEY_NAME_OPTION: \n $KEY_NAME_OPTION\n\n"

if [ -z $1 ]; then
    echo "No argument given, maximum spot instance price will be on-demand price"
    SPOT_PRICE_OPTION=""
else
    echo "Using $1 as maximum spot price."
    SPOT_PRICE_OPTION="--spot-price \"$1\""
fi

# Base64-Encode the userdata start file for the json
USERDATA_STR=$(base64 -w0 userdata)

echo "Re-creating temporary configuration directory"
confdir=./inst-tmp
[ -e $confdir ] && rm -r $confdir
mkdir $confdir

# read the list of instance types from stdin
while read instance_type
do
    conffile=$confdir/conf-$instance_type.json
    echo "Generating launch configuration file for $instance_type."
    echo "Writing to $conffile."

    # --iam-instance-profile Name=$IAM_PROFILE \
    # --instance-initiated-shutdown-behavior terminate \
    # --region $REGION \
    # --user-data file://userdata
    cat > $conffile <<-EOF
{
  "InstanceType": "$instance_type",
  "ImageId": "$AMI",
  $PLACEMENT_OPTION
  $KEY_NAME_OPTION
  "IamInstanceProfile": {
    "Name": "$IAM_PROFILE"
  },
  "UserData": "$USERDATA_STR"
}
EOF

    if [ ! -z $1 ]; then
        echo -e "\nArgument given, doing dry run (not executing spot request)"
        echo -e "Configuration file contents: \n------------------"
        cat $conffile
        echo "---------------------"
        break;
    fi
    # request the spot instance
    echo "Requesting spot instance for $instance_type"
    aws ec2 request-spot-instances \
        --instance-count 1 \
        --type "one-time" \
        $SPOT_PRICE_OPTION \
        --launch-specification file://$conffile
done
