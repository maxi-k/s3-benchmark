#!/bin/bash

# go the ec2-user home dir
cd /home/ec2-user

# download the test program
ARCH=$(arch)
if [ $ARCH = "aarch64" ]; then
    binvar=linux-arm64
else
    binvar=linux-amd64
fi
curl -Lo s3-benchmark \
     https://github.com/maxi-k/s3-benchmark/raw/usecase-multifile/build/$binvar/s3-benchmark

# make it executable
chmod +x s3-benchmark

# run the benchmark, upload the results and OS stats to S3
timestamp=csv-$(date +%F--%H-%M-%S)
./s3-benchmark \
    -object-name-pattern "benchmark/multifile/size-%sM-zero/%s.bin" \
    -upload-csv bench-$timestamp \
    -upload-stats stats-$timestamp \
    -threads-min 1 -threads-max 2 \
    -payloads-min 1 -payloads-max 64
    # -payloads-reverse


# shutdown to terminate the instance after the test is complete
shutdown now
