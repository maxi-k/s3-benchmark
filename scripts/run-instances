#!/bin/bash

# Preamble: Parse parameters, print configuration
source ./shared/util.sh
ensure_parameters
print_configuration

# Create AWS CLI option strings for some parameters
if [ -z $AVAILABILITY_ZONE ]; then
    PLACEMENT_OPTION=""
else
    PLACEMENT_OPTION=" --placement AvailabilityZone=$AVAILABILITY_ZONE"
fi
echo -e "Calculated PLACEMENT_OPTION: \t $PLACEMENT_OPTION"

if [ -z $KEY_NAME ]; then
    KEY_NAME_OPTION=""
else
    KEY_NAME_OPTION=" --key-name $KEY_NAME"
fi
echo -e "Calculated KEY_NAME_OPTION: \t $KEY_NAME_OPTION"

USERDATA_FILE=${1:-"userdata-s3"}

i=0
# read the list of instance types from stdin
while read instance_type
do
    # print the instance type
    echo "Running benchmark on $instance_type"

    # start the instance
    aws ec2 run-instances \
        --instance-type $instance_type \
        --image-id $AMI \
        --count 1 \
        --iam-instance-profile Name=$IAM_PROFILE \
        --instance-initiated-shutdown-behavior terminate \
        $PLACEMENT_OPTION \
        $KEY_NAME_OPTION \
        --region $REGION \
        --user-data file://$USERDATA_FILE
        # --subnet-id $SUBNET
        i=$[$i +1]

    # sleep for 30 minutes after 5 instances
    n=$(($i%5))
    if [ $n -eq 0 ]
    then
        echo "Sleeping for 30 minutes"
        sleep 1800
    fi
done
